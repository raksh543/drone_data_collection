<!DOCTYPE html>
<html lang="en">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<head>
    <meta charset="UTF-8">
    <title>Colleting Data</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

</head>
<body class="container" style="margin-top: 50px; width: 80%; height:auto;">
  <h2 class="text-primary" style="margin-left: 10%; margin-bottom: 10px">Hey There,Help Us In Collecting Data</h2>
    <br>
    <a target="_blank" href="https://drive.google.com/drive/folders/16gRxcGkjr_TiNS_cZ31QjPYy01w1bbWs"> Example Video </a>
    <br>
    <br>
    <form class="container" id="contactForm">
      <div class="card">
      <div class="card-body">
      <div class="form-group">
        <label for="exampleFormControlInput1">Enter Your Name</label>
        <input type="text" class="form-control" id="name" placeholder="Enter your name">
      </div>
      <div class="form-group">
        <label for="exampleFormControlInput1">Enter Your Roll</label>
        <input type="number" class="form-control" id="roll" placeholder="Roll Number">
      </div>
      <div class="form-group">
        <label for="exampleFormControlInput1">Email address</label>
        <input type="email" class="form-control" id="email" placeholder="name@example.com">
      </div>
      <div class="form-group">
      <div id="fieldDiv" style="margin-bottom: 10px">
    	
      </div>
    <button type="button" onclick="addField()">Add More Video</button><br><br>
  </div>
</div>
<button type="button" onclick="uploadVideo()" class="btn btn-primary" style="margin-left: 15px; margin-top: 10px">Submit</button>

</form>
</body>
<script src="https://www.gstatic.com/firebasejs/3.7.4/firebase.js"></script>
<script>
  var firebaseConfig = {
    apiKey: "AIzaSyDejn6WX2l2Tru-VaxbKgVsS6Tj2EHqx7k",
    authDomain: "chatapplication-f88c0.firebaseapp.com",
    databaseURL: "https://chatapplication-f88c0.firebaseio.com",
    projectId: "chatapplication-f88c0",
    storageBucket: "chatapplication-f88c0.appspot.com",
    messagingSenderId: "1002691238689",
    appId: "1:1002691238689:web:052f3c5c6c7e188aaebc60"
  };
  firebase.initializeApp(firebaseConfig);
  var messagesRef = firebase.database().ref('Collected Data');
  // document.getElementById('contactForm').addEventListener('submit', submitForm);

  var numOfVideo = 0;
  function addField(){
  	numOfVideo++;
    console.log(`video` + numOfVideo)
  	var element = `
  	<div style="display: flex">
  	<div style="width: 30%;">
       <input id="video` + numOfVideo +  `" type="file" name="files[]" accept="video/*">
  	</div>
  	<div style="width: 30%;"> 
  		 <select style={width: 50%} id="classSelector` + numOfVideo + `" class="form-control">
      <option>south</option>
      <option>north</option>
      <option>west</option>
      <option>east</option>
      <option>northEast</option>
      <option>northWest</option>
      <option>southEast</option>
      <option>southWest</option>
      <option>up</option>
      <option>down</option>
      <option>speedIncrease</option>
      <option>speedDecrease</option>
    </select>
  	</div>
  	</div>
   `
    $("#fieldDiv").append(element);
  }
 
  function uploadVideo(){
  	console.log("working")
  	console.log("")
  	var storage = firebase.storage();
   	var storageref=storage.ref();
    for(let j = 1; j<=numOfVideo; j++){
      let file=document.getElementById("video" + j).files[0];
      if (file.size > 2097152) // 2 mb for bytes.
      {
        alert( j +"th File size is greater then 2mb!");
        return;
      }
      console.log(file.size)
    }
    console.log("checking for length");
    for(let i = 1;i<=numOfVideo; i++){
      var vid = document.createElement('video');
      let file=document.getElementById("video" + i).files[0];
      // create url to use as the src of the video
      var fileURL = URL.createObjectURL(file);
      vid.src = fileURL;
      // wait for duration to change from NaN to the actual duration
      vid.ondurationchange = function() {
        console.log("started")
        if(this.duration > 5.2 || this.duration < 3 ){
          alert("video number " + i + " length is greater then 5 or less then 3")
          return;
        }
        // let file=document.getElementById("video" + i).files[0];
        var type = getInputVal('classSelector' + i);
        var thisref=storageref.child(type).child(Date.now()+getInputVal('roll') + file.name).put(file);
        thisref.on('state_changed',
          function(snapshot) {}, 
          function(error) {
            alert("not done")
          },
          function() {
            // Uploaded completed successfully, now we can get the download URL
            thisref.snapshot.ref.getDownloadURL().then(function(downloadURL) {
              setDatabase(i,downloadURL);
              if(i==numOfVideo){
                alert("Task Completed!! Thanks for providing data")
              }
            });
          }
        );
      };
    }

    console.log("checking for length completed");
  }
  function setDatabase(num,url){

  // Get values
  var name = getInputVal('name');
  var roll = getInputVal('roll');
  var email = getInputVal('email');
  var type = getInputVal('classSelector' + num);
  console.log("setting database")

  // Save message
  saveFileData(name, roll, email, url,type);

  // Show alert
  // Hide alert after 3 seconds


  // Clear form
  // document.getElementById('contactForm').reset();
  }

  // Function to get get form values
  function getInputVal(id){
    return document.getElementById(id).value;
  }

  // Save message to firebase
  function saveFileData(name, roll, email, url,type){
    var newMessageRef = messagesRef.child(roll).push();
    newMessageRef.set({
      name: name,
      roll:roll,
      email:email,
      videourl:url,
      class:type
    });
  }
</script>
</html>